@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@using Fr.EQL.AI109.Tontapat.Model

@model PrestationDetail

@{
    string InstallationString = null;
    if (Model.TypeInstallationFinal == true)
    {
        InstallationString = "la charge de l'éleveur";
    }
    else
    {
        InstallationString = "votre charge";
    }
    string CancelledString = " (annulée le ";
}


<h1>Prestation #@(Model.DateDemande.ToString("yyMMdd"))-@Model.Id</h1>

<div class="box-offre-details-header">
    <div>
        <img class="img-offre-thumbnail-profil" src="~/img/photos/profile/@(Model.IdEleveur).png" />
        Réalisée par <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a>
    </div>
    <div class="box-boutons">
        <button class="btn-primary" type="reset" form="offre" value="negociate">Négocier</button>
        <button class="btn-danger" type="submit" form="offre" value="cancel">Annuler la prestation</button>
    </div>
</div>

<div class="box-offre-details">

    <div class="offre-details-main">
        <div class="box-offre">
            <div class="info-offre">
                <h3>Caractéristiques</h3>

                <table class="offre-features">
                    <tr>
                        <td>
                            <i class="fas fa-location-arrow"></i>
                        </td>
                        <td>
                            @Model.NomTerrain, (VILLE)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img class="icon-list" src="~/img/icons/espece/@(Model.IdEspeceTroupeau).png" />
                        </td>
                        <td>
                            @Model.NomRaceTroupeau (@Model.NombreBetes)
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <i class="fas fa-calendar-alt"></i>
                        </td>
                        <td>
                            Du @Model.DateDebut.ToString("dd/MM/yy") au @Model.DateFin.ToString("dd/MM/yy")
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <i class="fas fa-tachometer-alt"></i>
                        </td>
                        <td>
                            Type de tonte : @Model.NomTypeTonte
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img class="icon-list" src="~/img/icons/install.png" />
                        </td>
                        <td>
                            Installation à @InstallationString
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <i class="fas fa-binoculars"></i>
                        </td>
                        <td>
                            Fréquence d'intervention : tous les @Model.FrequenceIntervention jours
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <i class="fa fa-times fa-lg"></i>
                        </td>
                        <td>
                            Conditions d'annulation : ???????????
                            <i class="far fa-question-circle" title="Annulation gratuite jusqu’à XX jours avant la prestation, facturation de la prestation à hauteur de XX% au-delà."></i>
                        </td>
                    </tr>

                </table>
            </div>
        </div>
    </div>

    <div class="offre-details-tarif">
        <div class="box-offre">
            <div class="info-offre tarif">
                <h3>Tarification</h3>
                <table class="tarif">
                    <tr>
                        <td>
                            Installation du matériel
                        </td>
                        <td class="prix">
                            @Model.PrixInstallationCloture€
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Installation du bétail
                        </td>
                        <td class="prix">
                            @Model.PrixInstallationBetail€
                        </td>
                    </tr>

                    <tr>
                        <td>
                            Frais de bétail
                        </td>
                        <td class="prix">
                            @Model.PrixBetail€
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Frais d'intervention
                        </td>
                        <td class="prix">
                            @Model.PrixIntervention€
                        </td>
                    </tr>
                    <tr>
                        <td>
                            Frais de service
                        </td>
                        <td class="prix">
                            @Model.PrixService€
                        </td>
                    </tr>
                    <tr>
                        <td>
                            TVA (20%)
                        </td>
                        <td class="prix">
                            @Model.PrixTVA€
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h4>Total</h4>
                        </td>
                        <td class="prix">
                            <h4>@Model.PrixConvenu€</h4>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

</div>
<div class="box-offre">
    <div class="info-offre">
        <h3>Historique</h3>
        <table class="historique-prestations">
            <tr>
                <td>
                    <i class="fas fa-arrow-up"></i>
                </td>
                <td>
                    Demande <strong>envoyée</strong> le @Model.DateDemande.ToString("dd/MM/yy") à partir de l'offre <a asp-controller="Offre" asp-action="Details" asp-route-id="">Offre</a> de <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a>.
                </td>
            </tr>
            @if (Model.DateValidation > Model.DateDemande)
            {
                <tr>
                    <td>
                        <i class="fas fa-check"></i>
                    </td>
                    <td>
                        Demande <strong>acceptée</strong> par <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @(((DateTime)(Model.DateValidation)).ToString("dd/MM/yy")).
                    </td>
                </tr>
            }
            else if (Model.DateRefus > Model.DateDemande)
            {
                <tr>
                    <td>
                        <i class="fas fa-times fa-lg"></i>
                    </td>
                    <td>
                        Demande <strong>refusée</strong> par <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @(((DateTime)(Model.DateRefus)).ToString("dd/MM/yy")) (Motif: @Model.DescriptionRefus).
                    </td>
                </tr>
            }
            @foreach (NegociationDetail nd in Model.Negociations)
            {
                <tr>
                    <td>
                        <i class="fas fa-comment-dollar"></i>
                    </td>
                    <td>
                        Négociation ouverte le @nd.DateOuverture.ToString("dd/MM/yy") :
                    </td>
                </tr>
                <tr>
                    <td>
                    </td>
                    <td>
                        <ul>
                            @foreach (Proposition p in nd.Propositions)
                            {
                                if (p.IdUtilisateur == Model.IdEleveur)
                                {
                                    <li>
                                        <i class="far fa-file-alt"></i> <strong>@(p == nd.Propositions[0] ? "Proposition" : "Contre-proposition")</strong> envoyée par <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @p.DateCreation.ToString("dd/MM/yy")
                                        @if (p.DateAnnulation != null)
                                        {
                                            <i>@(p.DateAnnulation > p.DateCreation ? ((DateTime)p.DateAnnulation).ToString("dd/MM/yy") : "jour-même")</i>

                                        }
                                    </li>
                                    if (p.DateValidation != null)
                                    {
                        <li><i class="fas fa-handshake"></i> Vous avez <strong>accepté</strong> la @(p == nd.Propositions[0] ? "proposition" : "contre-proposition") de <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @(((DateTime)p.DateValidation).ToString("dd/MM/yy"))</li>

                                    }
                                    else if (p.DateRefus != null)
                                    {
                        <li><i class="fas fa-times"></i> Vous avez <strong>refusé</strong> la @(p == nd.Propositions[0] ? "proposition" : "contre-proposition") de <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @(((DateTime)p.DateValidation).ToString("dd/MM/yy"))</li>

                                    }
                                }
                                else
                                {
                                    <li>
                                        <i class="far fa-file-alt"></i> @(p == nd.Propositions[0] ? "Proposition faite" : "Contre-proposition envoyée") par <strong>vous</strong> le @p.DateCreation.ToString("dd/MM/yy")
                                        @if (p.DateAnnulation != null)
                                        {
                                    <i>Annulée le @(p.DateAnnulation == p.DateCreation ? ((DateTime)p.DateAnnulation).ToString("dd/MM/yy") : "jour-même)")</i>        
                                        }
                                    </li>
                                    if (p.DateValidation != null)
                                        {
                                        <li><i class="fas fa-handshake"></i> <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> a <strong>accepté</strong> votre @(p == nd.Propositions[0] ? "proposition" : "contre-proposition") le @(((DateTime)p.DateValidation).ToString("dd/MM/yy"))</li>

                                    }
                                    else if (p.DateRefus != null)
                                    {
                        <li><i class="fas fa-times"></i> <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> a <strong>refusé</strong> votre @(p == nd.Propositions[0] ? "proposition" : "contre-proposition") le @(((DateTime)p.DateRefus).ToString("dd/MM/yy"))</li>

                                    }
                                }
                            }
                        </ul>
                    </td>
                </tr>
            }

            <tr>
                <td>
                    <i class="fas fa-hourglass-start"></i>
                </td>
                <td>
                    La prestation <strong>@(Model.DateDebut > DateTime.Today ? "commencera" : "a commencé")</strong> le @Model.DateDebut.ToString("dd/MM/yy")
                </td>
            </tr>
            <tr>
                <td></td>
                <td>
                    <ul>
@*             @{
                            int nbInterventionsDemandees = 0;
                            int j = 0;
                            int nbInterventionsProgrammees = (int)(Model.DateFin - Model.DateDebut).TotalDays / Model.FrequenceIntervention;
                            for (int i = 0; i <= nbInterventionsProgrammees; i++)
                            {
                                if(Model.DateDebut.AddDays(i * Model.FrequenceIntervention) > Model.Interventions)
                        {
                        }
                                <li>
                                    <strong>Intervention programmée</strong> de <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le @(Model.DateDebut.AddDays(i*Model.FrequenceIntervention))
                                </li>

                            }

                        }*@
                    </ul>

                        <li>
                            <strong>Intervention demandée</strong> par <strong>vous</strong> le xx/xx/xx
                        </li>
                        <li>
                            Demande d'intervention <strong>acceptée</strong> par <a asp-controller="Utilisateur" asp-action="Details" asp-route-id="@Model.Id">@Model.PrenomEleveur</a> le xx/xx/xx
                        </li>
                    </ul>
                </td>
            </tr>
            
            <tr>
                <td>
                    <i class="fas fa-hourglass-end"></i>
                </td>
                <td>
                    La prestation s'est <strong>terminée</strong> le @Model.DateFin.ToString("dd/MM/yy")
                </td>
            </tr>
        </table>
    </div>
</div>

<div class="box-boutons">
    <button class="btn-primary" type="reset" form="offre" value="negociate">Négocier</button>
    <button class="btn-danger" type="submit" form="offre" value="cancel">Annuler la prestation</button>
</div>
